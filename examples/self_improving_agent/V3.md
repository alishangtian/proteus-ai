**è‡ªæˆ‘è¿›åŒ–æ™ºèƒ½ä½“ç³»ç»Ÿï¼ˆSelf-Improving Agent Systemï¼‰è®¾è®¡æ„æƒ³**

è¯¥è®¾è®¡æ„æƒ³æç»˜äº†ä¸€ä¸ªåŸºäºReActèŒƒå¼çš„æ™ºèƒ½ä½“å¦‚ä½•é€šè¿‡ä¸äººã€ç¯å¢ƒçš„äº¤äº’å®ç°è‡ªæˆ‘è¿›åŒ–ï¼Œæœ€ç»ˆæˆä¸ºç‰¹å®šé¢†åŸŸä¸“å®¶çš„ç³»ç»Ÿã€‚

**ä¸€ã€æ ¸å¿ƒæ¦‚å¿µä¸è¿ä½œåŸç†**

1.  **åŸç”Ÿå½¢æ€ï¼š** ç³»ç»Ÿåˆå§‹ä¸ºä¸€ä¸ªå…¸å‹çš„ReAct Agentï¼Œå…·å¤‡åŸºç¡€çš„å·¥å…·é›†ï¼ˆToolsï¼‰å’Œæç¤ºè¯ï¼ˆPromptï¼‰ã€‚
2.  **è®°å¿†èƒ½åŠ›ï¼š** Agentåœ¨äº¤äº’è¿‡ç¨‹ä¸­ï¼Œä¼šç”Ÿæˆå¹¶ç§¯ç´¯ä¸åŒç»´åº¦çš„è®°å¿†ï¼Œè¿™äº›è®°å¿†æ˜¯å…¶è¿›åŒ–çš„æ ¸å¿ƒé©±åŠ¨åŠ›ã€‚
    *   **Tool Memory (å·¥å…·è®°å¿†)ï¼š** ç”¨äºä¼˜åŒ–Agentå¯¹å·¥å…·çš„é€‰æ‹©å’Œä½¿ç”¨ã€‚å®ƒè®°å½•äº†å·¥å…·è°ƒç”¨çš„æ ¸å¿ƒè¦ç‚¹ï¼ŒæŒ‡å¯¼Agentåœ¨é¢å¯¹ç±»ä¼¼é—®é¢˜æ—¶æ›´æœ‰æ•ˆåœ°é€‰æ‹©å’Œè°ƒç”¨å·¥å…·ã€‚
    *   **SOP Memory (æ ‡å‡†æ“ä½œæµç¨‹è®°å¿†)ï¼š** ç”¨äºæŒ‡å¯¼Agentæ›´å¥½åœ°ç”Ÿæˆè§£å†³é—®é¢˜çš„â€œå‰§æœ¬â€ï¼ˆPlaybookï¼‰ã€‚å®ƒæç‚¼äº†é—®é¢˜è§£å†³çš„æ ‡å‡†æµç¨‹ï¼Œæ˜¯æ¦‚æ‹¬æ€§çš„æŒ‡å¯¼æ–‡æœ¬ï¼Œä¸æ¶‰åŠå…·ä½“çš„å·¥å…·è°ƒç”¨ç»†èŠ‚ã€‚
3.  **è¿›åŒ–è¿‡ç¨‹ï¼š** Agenté€šè¿‡æŒç»­ç”Ÿæˆå’Œç§¯ç´¯Tool Memoryå’ŒSOP Memoryï¼Œä¸æ–­ä¼˜åŒ–å…¶å·¥å…·é€‰æ‹©ç­–ç•¥å’Œé—®é¢˜è§£å†³å‰§æœ¬ç”Ÿæˆèƒ½åŠ›ï¼Œä»è€Œå®ç°è‡ªæˆ‘æ”¹è¿›å’Œè¿›åŒ–ã€‚
4.  **æœ€ç»ˆç›®æ ‡ï¼š** æˆä¸ºä¸€ä¸ªèƒ½å¤Ÿé€‚åº”ç‰¹å®šè¯­å¢ƒå’Œç¯å¢ƒï¼Œè§£å†³æŸä¸€ç±»æˆ–æŸå‡ ç±»é—®é¢˜çš„ä¸“å®¶çº§æ™ºèƒ½ä½“ã€‚

**äºŒã€ç³»ç»Ÿæ„æˆä¸å…³é”®ç»„ä»¶**

1.  **ReAct Agentï¼š** æ•´ä¸ªç³»ç»Ÿçš„åŸºç¡€æ¡†æ¶ï¼Œè´Ÿè´£æ¨ç†ã€è¡ŒåŠ¨å’Œè§‚å¯Ÿçš„å¾ªç¯ã€‚
2.  **å·¥å…·ï¼ˆToolsï¼‰ï¼š** Agentæ‰§è¡Œä»»åŠ¡æ‰€éœ€çš„åŠŸèƒ½æ¨¡å—ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š
    *   `search_tool` (æœç´¢å·¥å…·)
    *   `crawler_tool` (çˆ¬è™«å·¥å…·)
    *   `python_excutor` (Pythonæ‰§è¡Œå™¨)
3.  **è®°å¿†æ¨¡å—ï¼ˆMemorysï¼‰ï¼š** å­˜å‚¨ä¸åŒç±»å‹ä¿¡æ¯çš„æ¨¡å—ï¼Œå…¶ç”Ÿæˆå®Œå…¨ä¾èµ–äºç³»ç»Ÿæç¤ºè¯å’Œæ¨¡å‹ã€‚
    *   `python_excutor_memory`
    *   `search_tool_memory`
    *   `crawler_tool_memory`
    *   `sop_memory`

**ä¸‰ã€ç³»ç»Ÿæç¤ºè¯ï¼ˆSystem Promptsï¼‰è®¾è®¡**

ç³»ç»Ÿé€šè¿‡ç²¾å¿ƒè®¾è®¡çš„æç¤ºè¯æ¥å¼•å¯¼Agentç”Ÿæˆå’Œåˆ©ç”¨è®°å¿†ï¼Œå®ç°è‡ªæˆ‘è¿›åŒ–ã€‚

1.  **`tool_memory` ç³»ç»Ÿæç¤ºè¯ï¼š**
    *   **è§’è‰²ï¼š** å·¥å…·é€‰æ‹©ä¸“å®¶ã€‚
    *   **ä»»åŠ¡ï¼š** æ ¹æ®å·¥å…·è°ƒç”¨è¯¦æƒ…ï¼ˆ`${tool_invoke_text}`ï¼‰å’Œç”¨æˆ·é—®é¢˜ï¼ˆ`${query}`ï¼‰ï¼Œæ€»ç»“è°ƒç”¨æ­¤å·¥å…·çš„æ ¸å¿ƒè¦ç‚¹ã€‚
    *   **è¾“å‡ºï¼š** ç”Ÿæˆå¹¶è¾“å‡ºå·¥å…·è°ƒç”¨çš„æ ¸å¿ƒè¦ç‚¹ã€‚

2.  **`playbook` ç³»ç»Ÿæç¤ºè¯ï¼š**
    *   **è§’è‰²ï¼š** å‰§æœ¬ç”Ÿæˆä¸“å®¶ã€‚
    *   **ä»»åŠ¡ï¼š** æ ¹æ®ç”¨æˆ·é—®é¢˜ï¼ˆ`${query}`ï¼‰ã€å·¥å…·åˆ—è¡¨ï¼ˆ`${tools}`ï¼‰ã€æœ€æ–°å·¥å…·è°ƒç”¨ç»“æœï¼ˆ`${tool_invoke_text}`ï¼‰å’Œå†å²å‰§æœ¬ï¼ˆ`${pre_playbook}`ï¼‰ï¼Œç”Ÿæˆèƒ½å¤Ÿè§£å†³ç”¨æˆ·é—®é¢˜çš„æ–°å‰§æœ¬ã€‚
    *   **å‰§æœ¬å†…å®¹è¦æ±‚ï¼š** å¿…é¡»æ¶µç›–ä»¥ä¸‹ä¸‰éƒ¨åˆ†ï¼š
        *   ä»»åŠ¡è§„åˆ’å’Œå®Œæˆåº¦ã€‚
        *   å·¥å…·è°ƒç”¨è¦ç‚¹æ€»ç»“ï¼ˆåªæå–è¦ç´ ï¼Œä¸è¿›è¡Œæ€»ç»“ï¼‰ã€‚
        *   å·¥å…·è°ƒç”¨è®°å½•ï¼ˆé™ˆåˆ—æ‰€æœ‰å·¥å…·è°ƒç”¨çš„æƒ…å†µï¼Œä¸è¿›è¡Œæ€»ç»“ï¼Œåªå¯¹`observation`è¿›è¡Œå¿…è¦çš„æ¦‚æ‹¬ï¼‰ã€‚
    *   **è¾“å‡ºï¼š** æ–°çš„å‰§æœ¬ã€‚

3.  **`sop` ç³»ç»Ÿæç¤ºè¯ï¼ˆåœ¨ä¸€æ¬¡å®Œæ•´çš„å¯¹è¯å®Œæˆåè§¦å‘ï¼‰ï¼š**
    *   **ä»»åŠ¡ï¼š** æ ¹æ®ç”¨æˆ·é—®é¢˜ï¼ˆ`${query}`ï¼‰ã€å‰§æœ¬ï¼ˆ`${playbook}`ï¼‰å’Œæœ€ç»ˆç»“æœï¼ˆ`${answer}`ï¼‰ï¼Œæç‚¼é—®é¢˜è§£å†³çš„æ ‡å‡†æµç¨‹ã€‚
    *   **æµç¨‹ç‰¹ç‚¹ï¼š** è¿™æ˜¯ä¸€ä¸ªæŒ‡å¯¼æ€§çš„ã€æ¦‚æ‹¬æ€§çš„æ–‡æœ¬ï¼Œä¸æ¶‰åŠå…·ä½“çš„å·¥å…·è°ƒç”¨ã€‚
    *   **è¾“å‡ºï¼š** è§£å†³ç”¨æˆ·é—®é¢˜çš„æ ‡å‡†æµç¨‹ã€‚

**å››ã€è‡ªæˆ‘æ”¹è¿›ä¸è¿›åŒ–è·¯å¾„**

è¯¥ç³»ç»Ÿé€šè¿‡ä»¥ä¸‹æœºåˆ¶å®ç°è‡ªæˆ‘æ”¹è¿›ï¼š

*   **ç»éªŒç§¯ç´¯ï¼š** Agentåœ¨æ¯æ¬¡ä»»åŠ¡æ‰§è¡Œä¸­ç§¯ç´¯Tool Memoryå’ŒSOP Memoryã€‚
*   **åé¦ˆå¾ªç¯ï¼š** è®°å¿†çš„ç”Ÿæˆå’Œåˆ©ç”¨å½¢æˆä¸€ä¸ªåé¦ˆå¾ªç¯ï¼Œä¸æ–­ä¼˜åŒ–Agentçš„å†³ç­–å’Œè¡ŒåŠ¨ã€‚
*   **ä¸“ä¸šåŒ–ï¼š** éšç€è®°å¿†çš„ä¸°å¯Œï¼ŒAgenté€æ¸åœ¨ç‰¹å®šé¢†åŸŸå½¢æˆä¸“ä¸šçŸ¥è¯†å’Œè§£å†³ç­–ç•¥ï¼Œæå‡å…¶è§£å†³å¤æ‚é—®é¢˜çš„èƒ½åŠ›ã€‚

è¿™ä¸ªè‡ªæˆ‘è¿›åŒ–æ™ºèƒ½ä½“ç³»ç»Ÿé€šè¿‡ReActæ¡†æ¶ã€å¤šç»´åº¦è®°å¿†æœºåˆ¶å’Œç²¾ç»†çš„æç¤ºè¯è®¾è®¡ï¼Œæ„å»ºäº†ä¸€ä¸ªèƒ½å¤ŸæŒç»­å­¦ä¹ ã€ä¼˜åŒ–å’Œä¸“ä¸šåŒ–çš„æ™ºèƒ½ä½“ã€‚å®ƒæ—¨åœ¨é€šè¿‡ä¸ç¯å¢ƒçš„æŒç»­äº¤äº’ï¼Œä»ç»éªŒä¸­å­¦ä¹ ï¼Œæœ€ç»ˆæˆä¸ºä¸€ä¸ªé«˜æ•ˆã€è‡ªé€‚åº”çš„é—®é¢˜è§£å†³ä¸“å®¶ã€‚

---

**å·¥ç¨‹å®ç°æ–¹æ¡ˆ**

**ä¸€ã€ç³»ç»Ÿæ¶æ„è®¾è®¡**

1.  **æ ¸å¿ƒAgentæ¨¡å—ï¼š**
    *   **ReAct Agent Coreï¼š** è´Ÿè´£æ¨ç†ã€è¡ŒåŠ¨ã€è§‚å¯Ÿå¾ªç¯çš„è°ƒåº¦ä¸æ‰§è¡Œã€‚
    *   **Prompt Managerï¼š** åŠ¨æ€ç®¡ç†å’ŒåŠ è½½ä¸åŒç±»å‹çš„æç¤ºè¯ï¼ˆç³»ç»Ÿæç¤ºè¯ã€å·¥å…·æç¤ºè¯ã€è®°å¿†ç”Ÿæˆæç¤ºè¯ç­‰ï¼‰ã€‚
    *   **Tool Orchestratorï¼š** è´Ÿè´£å·¥å…·çš„æ³¨å†Œã€å‘ç°ã€è°ƒç”¨å’Œç»“æœå¤„ç†ã€‚

2.  **è®°å¿†ç®¡ç†æ¨¡å—ï¼š**
    *   **Memory Storeï¼š** ç»Ÿä¸€çš„è®°å¿†å­˜å‚¨æ¥å£ï¼Œåº•å±‚å¯å¯¹æ¥å¤šç§å­˜å‚¨æ–¹æ¡ˆï¼ˆå¦‚å‘é‡æ•°æ®åº“ã€å…³ç³»å‹æ•°æ®åº“ã€KVå­˜å‚¨ï¼‰ã€‚
    *   **Memory Generatorï¼š** æ ¹æ®é¢„è®¾çš„æç¤ºè¯å’ŒAgentçš„äº¤äº’æ•°æ®ï¼Œç”ŸæˆTool Memoryå’ŒSOP Memoryã€‚
    *   **Memory Retrieverï¼š** æ ¹æ®å½“å‰ä»»åŠ¡å’Œä¸Šä¸‹æ–‡ï¼Œä»Memory Storeä¸­æ£€ç´¢ç›¸å…³çš„Tool Memoryå’ŒSOP Memoryã€‚
    *   **Memory Updaterï¼š** è´Ÿè´£è®°å¿†çš„æ›´æ–°ã€åˆå¹¶ã€å»é‡å’Œæ·˜æ±°ç­–ç•¥ã€‚

3.  **å·¥å…·æ¨¡å—ï¼š**
    *   **Tool Registryï¼š** æ³¨å†Œæ‰€æœ‰å¯ç”¨å·¥å…·åŠå…¶å…ƒæ•°æ®ï¼ˆæè¿°ã€å‚æ•°ã€è¾“å‡ºï¼‰ã€‚
    *   **Tool Adaptersï¼š** å°†é€šç”¨å·¥å…·æ¥å£é€‚é…åˆ°å…·ä½“å·¥å…·çš„è°ƒç”¨æ–¹å¼ã€‚

4.  **å¤–éƒ¨æ¥å£å±‚ï¼š**
    *   **User Interface (UI/API)ï¼š** æä¾›ä¸ç”¨æˆ·äº¤äº’çš„ç•Œé¢æˆ–APIæ¥å£ã€‚
    *   **Environment Adaptersï¼š** ä¸å¤–éƒ¨ç¯å¢ƒï¼ˆå¦‚æ“ä½œç³»ç»Ÿã€ç¬¬ä¸‰æ–¹æœåŠ¡ï¼‰è¿›è¡Œäº¤äº’çš„é€‚é…å™¨ã€‚

**äºŒã€å…³é”®æŠ€æœ¯é€‰å‹**

1.  **å¤§å‹è¯­è¨€æ¨¡å‹ (LLM)ï¼š**
    *   **æ ¸å¿ƒæ¨ç†ï¼š** é€‰ç”¨é«˜æ€§èƒ½çš„LLMï¼ˆå¦‚GPT-4ã€Claude 3ã€Llama 3ç­‰ï¼‰ä½œä¸ºReAct Agentçš„æ ¸å¿ƒæ¨ç†å¼•æ“ã€‚
    *   **è®°å¿†ç”Ÿæˆï¼š** åŒæ ·åˆ©ç”¨LLMæ ¹æ®ç‰¹å®šæç¤ºè¯ç”ŸæˆTool Memoryå’ŒSOP Memoryã€‚

2.  **è®°å¿†å­˜å‚¨ï¼š**
    *   **å‘é‡æ•°æ®åº“ï¼š** ç”¨äºå­˜å‚¨Tool Memoryå’ŒSOP Memoryçš„åµŒå…¥å‘é‡ï¼Œå®ç°é«˜æ•ˆçš„è¯­ä¹‰æ£€ç´¢ï¼ˆå¦‚Pinecone, Weaviate, Milvus, Qdrantï¼‰ã€‚
    *   **å…³ç³»å‹æ•°æ®åº“/KVå­˜å‚¨ï¼š** ç”¨äºå­˜å‚¨è®°å¿†çš„åŸå§‹æ–‡æœ¬å†…å®¹å’Œå…ƒæ•°æ®ï¼ˆå¦‚PostgreSQL, Redisï¼‰ã€‚

3.  **æ¶ˆæ¯é˜Ÿåˆ— (Message Queue)ï¼š**
    *   **æ¨¡å—é—´é€šä¿¡ï¼š** ç”¨äºè§£è€¦Agentæ ¸å¿ƒä¸è®°å¿†ç®¡ç†æ¨¡å—ã€å·¥å…·æ¨¡å—ä¹‹é—´çš„é€šä¿¡ï¼Œå®ç°å¼‚æ­¥å¤„ç†å’Œé«˜å¹¶å‘ï¼ˆå¦‚Kafka, RabbitMQ, Pulsarï¼‰ã€‚

4.  **æ¡†æ¶ä¸åº“ï¼š**
    *   **Agentæ¡†æ¶ï¼š** å¯ä»¥åŸºäºLangChainã€LlamaIndexç­‰ç°æœ‰æ¡†æ¶è¿›è¡ŒäºŒæ¬¡å¼€å‘ï¼Œæˆ–è‡ªè¡Œæ„å»ºè½»é‡çº§æ¡†æ¶ã€‚
    *   **Webæ¡†æ¶ï¼š** ç”¨äºæ„å»ºUI/APIæ¥å£ï¼ˆå¦‚FastAPI, Flask, Djangoï¼‰ã€‚

**ä¸‰ã€æ•°æ®æµè½¬ä¸å­˜å‚¨æ–¹æ¡ˆ**

1.  **æ•°æ®æµè½¬ï¼š**
    *   **ç”¨æˆ·è¯·æ±‚ï¼š** ç”¨æˆ·é€šè¿‡UI/APIæäº¤ä»»åŠ¡ã€‚
    *   **Agentå¤„ç†ï¼š** ReAct Agent Coreæ¥æ”¶è¯·æ±‚ï¼Œæ ¹æ®Playbookè¿›è¡Œæ¨ç†ï¼Œè°ƒç”¨å·¥å…·ã€‚
    *   **è®°å¿†ç”Ÿæˆï¼š** åœ¨å·¥å…·è°ƒç”¨åï¼ŒTool Orchestratorå°†è°ƒç”¨è¯¦æƒ…å‘é€ç»™Memory Generatorç”ŸæˆTool Memoryï¼›åœ¨ä»»åŠ¡å®Œæˆåï¼ŒAgentå°†Playbookå’Œæœ€ç»ˆç»“æœå‘é€ç»™Memory Generatorç”ŸæˆSOP Memoryã€‚
    *   **è®°å¿†æ£€ç´¢ï¼š** Agentåœ¨æ¨ç†è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡Memory Retrieverä»Memory Storeä¸­æ£€ç´¢ç›¸å…³è®°å¿†ï¼Œè¾…åŠ©å†³ç­–ã€‚
    *   **ç»“æœè¿”å›ï¼š** Agentå°†æœ€ç»ˆç­”æ¡ˆè¿”å›ç»™ç”¨æˆ·ã€‚

2.  **æ•°æ®å­˜å‚¨ï¼š**
    *   **åŸå§‹äº¤äº’æ•°æ®ï¼š** å­˜å‚¨Agentä¸ç”¨æˆ·ã€ç¯å¢ƒçš„æ‰€æœ‰äº¤äº’æ—¥å¿—ï¼Œç”¨äºå®¡è®¡å’Œå›æº¯ã€‚
    *   **Tool Memoryï¼š** å­˜å‚¨å·¥å…·è°ƒç”¨çš„æ ¸å¿ƒè¦ç‚¹ï¼ŒåŒ…å«åŸå§‹æ–‡æœ¬ã€åµŒå…¥å‘é‡ã€å…³è”çš„ç”¨æˆ·é—®é¢˜ã€è°ƒç”¨ä¸Šä¸‹æ–‡ç­‰ã€‚
    *   **SOP Memoryï¼š** å­˜å‚¨é—®é¢˜è§£å†³çš„æ ‡å‡†æµç¨‹ï¼ŒåŒ…å«åŸå§‹æ–‡æœ¬ã€åµŒå…¥å‘é‡ã€å…³è”çš„ç”¨æˆ·é—®é¢˜ã€Playbookç­‰ã€‚
    *   **Playbookå†å²ï¼š** å­˜å‚¨æ¯æ¬¡ä»»åŠ¡æ‰§è¡Œçš„Playbookï¼Œç”¨äºSOP Memoryçš„ç”Ÿæˆå’Œå†å²å›æº¯ã€‚

**å››ã€è®°å¿†çš„ç”Ÿæˆä¸ç®¡ç†æœºåˆ¶**

1.  **è®°å¿†ç”Ÿæˆï¼š**
    *   **Tool Memoryç”Ÿæˆï¼š** æ¯æ¬¡å·¥å…·è°ƒç”¨æˆåŠŸåï¼Œæ ¹æ®`tool_memory`ç³»ç»Ÿæç¤ºè¯ï¼Œç”±LLMä»`tool_invoke_text`å’Œ`query`ä¸­æç‚¼æ ¸å¿ƒè¦ç‚¹ï¼Œç”ŸæˆTool Memoryã€‚
    *   **SOP Memoryç”Ÿæˆï¼š** åœ¨ä¸€æ¬¡å®Œæ•´çš„å¯¹è¯ï¼ˆä»»åŠ¡ï¼‰å®Œæˆåï¼Œæ ¹æ®`sop`ç³»ç»Ÿæç¤ºè¯ï¼Œç”±LLMä»`query`ã€`playbook`å’Œ`answer`ä¸­æç‚¼æ ‡å‡†æ“ä½œæµç¨‹ï¼Œç”ŸæˆSOP Memoryã€‚

2.  **è®°å¿†ç®¡ç†ï¼š**
    *   **å»é‡ä¸åˆå¹¶ï¼š** å¯¹äºç›¸ä¼¼æˆ–é‡å¤çš„è®°å¿†ï¼Œè¿›è¡Œå»é‡æˆ–åˆå¹¶ï¼Œé¿å…å†—ä½™ã€‚
    *   **ç‰ˆæœ¬æ§åˆ¶ï¼š** å¯¹è®°å¿†è¿›è¡Œç‰ˆæœ¬ç®¡ç†ï¼Œå…è®¸å›æº¯å’Œæ¯”è¾ƒä¸åŒç‰ˆæœ¬çš„è®°å¿†ã€‚
    *   **æ·˜æ±°æœºåˆ¶ï¼š** æ ¹æ®è®°å¿†çš„ä½¿ç”¨é¢‘ç‡ã€æ—¶æ•ˆæ€§ç­‰ç­–ç•¥ï¼Œå®šæœŸæ·˜æ±°ä½ä»·å€¼è®°å¿†ã€‚
    *   **è¯„ä¼°ä¸ä¼˜åŒ–ï¼š** å®šæœŸè¯„ä¼°è®°å¿†çš„è´¨é‡å’Œæœ‰æ•ˆæ€§ï¼Œé€šè¿‡äººå·¥æ ‡æ³¨æˆ–Agentè‡ªè¯„ä¼°æ¥ä¼˜åŒ–è®°å¿†ç”Ÿæˆç­–ç•¥ã€‚

**äº”ã€æ¨¡å—é—´é€šä¿¡æœºåˆ¶**

1.  **åŒæ­¥é€šä¿¡ï¼š**
    *   **Agentæ ¸å¿ƒä¸å·¥å…·è°ƒç”¨ï¼š** ReAct Agent Coreé€šè¿‡Tool OrchestratoråŒæ­¥è°ƒç”¨å·¥å…·ï¼Œç­‰å¾…ç»“æœè¿”å›ã€‚
    *   **Agentæ ¸å¿ƒä¸è®°å¿†æ£€ç´¢ï¼š** Agentåœ¨æ¨ç†æ—¶åŒæ­¥è°ƒç”¨Memory Retrieverè·å–ç›¸å…³è®°å¿†ã€‚

2.  **å¼‚æ­¥é€šä¿¡ï¼š**
    *   **è®°å¿†ç”Ÿæˆï¼š** å·¥å…·è°ƒç”¨ç»“æœå’Œä»»åŠ¡å®Œæˆäº‹ä»¶é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å‘é€ç»™Memory Generatorï¼Œé¿å…é˜»å¡Agentæ ¸å¿ƒã€‚
    *   **è®°å¿†æ›´æ–°ï¼š** Memory Updaterå¯¹è®°å¿†çš„å»é‡ã€åˆå¹¶ã€æ·˜æ±°ç­‰æ“ä½œå¯ä»¥å¼‚æ­¥è¿›è¡Œã€‚

**å…­ã€æŒç»­ä¼˜åŒ–ä¸è¿›åŒ–**

1.  **A/Bæµ‹è¯•ï¼š** å¯¹ä¸åŒçš„è®°å¿†ç”Ÿæˆç­–ç•¥ã€æ£€ç´¢ç®—æ³•è¿›è¡ŒA/Bæµ‹è¯•ï¼Œè¯„ä¼°æ•ˆæœã€‚
2.  **äººå·¥åé¦ˆï¼š** å¼•å…¥äººå·¥æ ‡æ³¨å’Œåé¦ˆæœºåˆ¶ï¼Œå¯¹Agentçš„å†³ç­–å’Œè®°å¿†è´¨é‡è¿›è¡Œç›‘ç£å’Œä¿®æ­£ã€‚
3.  **è‡ªç›‘ç£å­¦ä¹ ï¼š** Agentå¯ä»¥æ ¹æ®ä»»åŠ¡çš„æˆåŠŸç‡ã€æ•ˆç‡ç­‰æŒ‡æ ‡ï¼Œè‡ªæˆ‘è¯„ä¼°è®°å¿†çš„æœ‰æ•ˆæ€§ï¼Œå¹¶è°ƒæ•´è®°å¿†ç”Ÿæˆå’Œåˆ©ç”¨ç­–ç•¥ã€‚
4.  **é¢†åŸŸé€‚åº”ï¼š** é’ˆå¯¹ç‰¹å®šé¢†åŸŸï¼Œé€šè¿‡é¢†åŸŸçŸ¥è¯†æ³¨å…¥å’Œå¾®è°ƒï¼ŒåŠ é€ŸAgentåœ¨è¯¥é¢†åŸŸçš„ä¸“ä¸šåŒ–è¿›ç¨‹ã€‚

**ä¼˜åŒ–ä¸å·¥ç¨‹å®ç°æ–¹æ¡ˆ**

**ä¸€ã€ç³»ç»Ÿæ¶æ„è®¾è®¡**

1.  **æ ¸å¿ƒAgentæ¨¡å—ï¼š**
    *   **ReAct Agent Coreï¼š** è´Ÿè´£æ¨ç†ã€è¡ŒåŠ¨ã€è§‚å¯Ÿå¾ªç¯çš„è°ƒåº¦ä¸æ‰§è¡Œã€‚
    *   **Prompt Managerï¼š** åŠ¨æ€ç®¡ç†å’ŒåŠ è½½ä¸åŒç±»å‹çš„æç¤ºè¯ï¼ˆç³»ç»Ÿæç¤ºè¯ã€å·¥å…·æç¤ºè¯ã€è®°å¿†ç”Ÿæˆæç¤ºè¯ç­‰ï¼‰ã€‚
    *   **Tool Orchestratorï¼š** è´Ÿè´£å·¥å…·çš„æ³¨å†Œã€å‘ç°ã€è°ƒç”¨å’Œç»“æœå¤„ç†ã€‚

2.  **è®°å¿†ç®¡ç†æ¨¡å—ï¼š**
    *   **Memory Storeï¼š** ç»Ÿä¸€çš„è®°å¿†å­˜å‚¨æ¥å£ï¼Œåº•å±‚å¯å¯¹æ¥å¤šç§å­˜å‚¨æ–¹æ¡ˆï¼ˆå¦‚å‘é‡æ•°æ®åº“ã€å…³ç³»å‹æ•°æ®åº“ã€KVå­˜å‚¨ï¼‰ã€‚
    *   **Memory Generatorï¼š** æ ¹æ®é¢„è®¾çš„æç¤ºè¯å’ŒAgentçš„äº¤äº’æ•°æ®ï¼Œç”ŸæˆTool Memoryå’ŒSOP Memoryã€‚
    *   **Memory Retrieverï¼š** æ ¹æ®å½“å‰ä»»åŠ¡å’Œä¸Šä¸‹æ–‡ï¼Œä»Memory Storeä¸­æ£€ç´¢ç›¸å…³çš„Tool Memoryå’ŒSOP Memoryã€‚
    *   **Memory Updaterï¼š** è´Ÿè´£è®°å¿†çš„æ›´æ–°ã€åˆå¹¶ã€å»é‡å’Œæ·˜æ±°ç­–ç•¥ã€‚

3.  **å·¥å…·æ¨¡å—ï¼š**
    *   **Tool Registryï¼š** æ³¨å†Œæ‰€æœ‰å¯ç”¨å·¥å…·åŠå…¶å…ƒæ•°æ®ï¼ˆæè¿°ã€å‚æ•°ã€è¾“å‡ºï¼‰ã€‚
    *   **Tool Adaptersï¼š** å°†é€šç”¨å·¥å…·æ¥å£é€‚é…åˆ°å…·ä½“å·¥å…·çš„è°ƒç”¨æ–¹å¼ã€‚

4.  **å¤–éƒ¨æ¥å£å±‚ï¼š**
    *   **User Interface (UI/API)ï¼š** æä¾›ä¸ç”¨æˆ·äº¤äº’çš„ç•Œé¢æˆ–APIæ¥å£ã€‚
    *   **Environment Adaptersï¼š** ä¸å¤–éƒ¨ç¯å¢ƒï¼ˆå¦‚æ“ä½œç³»ç»Ÿã€ç¬¬ä¸‰æ–¹æœåŠ¡ï¼‰è¿›è¡Œäº¤äº’çš„é€‚é…å™¨ã€‚

**äºŒã€å…³é”®æŠ€æœ¯é€‰å‹**

1.  **å¤§å‹è¯­è¨€æ¨¡å‹ (LLM)ï¼š**
    *   **æ ¸å¿ƒæ¨ç†ï¼š** é€‰ç”¨é«˜æ€§èƒ½çš„LLMï¼ˆå¦‚GPT-4ã€Claude 3ã€Llama 3ç­‰ï¼‰ä½œä¸ºReAct Agentçš„æ ¸å¿ƒæ¨ç†å¼•æ“ã€‚
    *   **è®°å¿†ç”Ÿæˆï¼š** åŒæ ·åˆ©ç”¨LLMæ ¹æ®ç‰¹å®šæç¤ºè¯ç”ŸæˆTool Memoryå’ŒSOP Memoryã€‚

2.  **è®°å¿†å­˜å‚¨ï¼š**
    *   **å‘é‡æ•°æ®åº“ï¼š** ç”¨äºå­˜å‚¨Tool Memoryå’ŒSOP Memoryçš„åµŒå…¥å‘é‡ï¼Œå®ç°é«˜æ•ˆçš„è¯­ä¹‰æ£€ç´¢ï¼ˆå¦‚Pinecone, Weaviate, Milvus, Qdrantï¼‰ã€‚
    *   **å…³ç³»å‹æ•°æ®åº“/KVå­˜å‚¨ï¼š** ç”¨äºå­˜å‚¨è®°å¿†çš„åŸå§‹æ–‡æœ¬å†…å®¹å’Œå…ƒæ•°æ®ï¼ˆå¦‚PostgreSQL, Redisï¼‰ã€‚

3.  **æ¶ˆæ¯é˜Ÿåˆ— (Message Queue)ï¼š**
    *   **æ¨¡å—é—´é€šä¿¡ï¼š** ç”¨äºè§£è€¦Agentæ ¸å¿ƒä¸è®°å¿†ç®¡ç†æ¨¡å—ã€å·¥å…·æ¨¡å—ä¹‹é—´çš„é€šä¿¡ï¼Œå®ç°å¼‚æ­¥å¤„ç†å’Œé«˜å¹¶å‘ï¼ˆå¦‚Kafka, RabbitMQ, Pulsarï¼‰ã€‚

4.  **æ¡†æ¶ä¸åº“ï¼š**
    *   **Agentæ¡†æ¶ï¼š** å¯ä»¥åŸºäºLangChainã€LlamaIndexç­‰ç°æœ‰æ¡†æ¶è¿›è¡ŒäºŒæ¬¡å¼€å‘ï¼Œæˆ–è‡ªè¡Œæ„å»ºè½»é‡çº§æ¡†æ¶ã€‚
    *   **Webæ¡†æ¶ï¼š** ç”¨äºæ„å»ºUI/APIæ¥å£ï¼ˆå¦‚FastAPI, Flask, Djangoï¼‰ã€‚

**ä¸‰ã€æ•°æ®æµè½¬ä¸å­˜å‚¨æ–¹æ¡ˆ**

1.  **æ•°æ®æµè½¬ï¼š**
    *   **ç”¨æˆ·è¯·æ±‚ï¼š** ç”¨æˆ·é€šè¿‡UI/APIæäº¤ä»»åŠ¡ã€‚
    *   **Agentå¤„ç†ï¼š** ReAct Agent Coreæ¥æ”¶è¯·æ±‚ï¼Œæ ¹æ®Playbookè¿›è¡Œæ¨ç†ï¼Œè°ƒç”¨å·¥å…·ã€‚
    *   **è®°å¿†ç”Ÿæˆï¼š** åœ¨å·¥å…·è°ƒç”¨åï¼ŒTool Orchestratorå°†è°ƒç”¨è¯¦æƒ…å‘é€ç»™Memory Generatorç”ŸæˆTool Memoryï¼›åœ¨ä»»åŠ¡å®Œæˆåï¼ŒAgentå°†Playbookå’Œæœ€ç»ˆç»“æœå‘é€ç»™Memory Generatorç”ŸæˆSOP Memoryã€‚
    *   **è®°å¿†æ£€ç´¢ï¼š** Agentåœ¨æ¨ç†è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡Memory Retrieverä»Memory Storeä¸­æ£€ç´¢ç›¸å…³è®°å¿†ï¼Œè¾…åŠ©å†³ç­–ã€‚
    *   **ç»“æœè¿”å›ï¼š** Agentå°†æœ€ç»ˆç­”æ¡ˆè¿”å›ç»™ç”¨æˆ·ã€‚

2.  **æ•°æ®å­˜å‚¨ï¼š**
    *   **åŸå§‹äº¤äº’æ•°æ®ï¼š** å­˜å‚¨Agentä¸ç”¨æˆ·ã€ç¯å¢ƒçš„æ‰€æœ‰äº¤äº’æ—¥å¿—ï¼Œç”¨äºå®¡è®¡å’Œå›æº¯ã€‚
    *   **Tool Memoryï¼š** å­˜å‚¨å·¥å…·è°ƒç”¨çš„æ ¸å¿ƒè¦ç‚¹ï¼ŒåŒ…å«åŸå§‹æ–‡æœ¬ã€åµŒå…¥å‘é‡ã€å…³è”çš„ç”¨æˆ·é—®é¢˜ã€è°ƒç”¨ä¸Šä¸‹æ–‡ç­‰ã€‚
    *   **SOP Memoryï¼š** å­˜å‚¨é—®é¢˜è§£å†³çš„æ ‡å‡†æµç¨‹ï¼ŒåŒ…å«åŸå§‹æ–‡æœ¬ã€åµŒå…¥å‘é‡ã€å…³è”çš„ç”¨æˆ·é—®é¢˜ã€Playbookç­‰ã€‚
    *   **Playbookå†å²ï¼š** å­˜å‚¨æ¯æ¬¡ä»»åŠ¡æ‰§è¡Œçš„Playbookï¼Œç”¨äºSOP Memoryçš„ç”Ÿæˆå’Œå†å²å›æº¯ã€‚

**å››ã€è®°å¿†çš„ç”Ÿæˆä¸ç®¡ç†æœºåˆ¶**

1.  **è®°å¿†ç”Ÿæˆï¼š**
    *   **Tool Memoryç”Ÿæˆï¼š** æ¯æ¬¡å·¥å…·è°ƒç”¨æˆåŠŸåï¼Œæ ¹æ®`tool_memory`ç³»ç»Ÿæç¤ºè¯ï¼Œç”±LLMä»`tool_invoke_text`å’Œ`query`ä¸­æç‚¼æ ¸å¿ƒè¦ç‚¹ï¼Œç”ŸæˆTool Memoryã€‚
    *   **SOP Memoryç”Ÿæˆï¼š** åœ¨ä¸€æ¬¡å®Œæ•´çš„å¯¹è¯ï¼ˆä»»åŠ¡ï¼‰å®Œæˆåï¼Œæ ¹æ®`sop`ç³»ç»Ÿæç¤ºè¯ï¼Œç”±LLMä»`query`ã€`playbook`å’Œ`answer`ä¸­æç‚¼æ ‡å‡†æ“ä½œæµç¨‹ï¼Œç”ŸæˆSOP Memoryã€‚

2.  **è®°å¿†ç®¡ç†ï¼š**
    *   **å»é‡ä¸åˆå¹¶ï¼š** å¯¹äºç›¸ä¼¼æˆ–é‡å¤çš„è®°å¿†ï¼Œè¿›è¡Œå»é‡æˆ–åˆå¹¶ï¼Œé¿å…å†—ä½™ã€‚
    *   **ç‰ˆæœ¬æ§åˆ¶ï¼š** å¯¹è®°å¿†è¿›è¡Œç‰ˆæœ¬ç®¡ç†ï¼Œå…è®¸å›æº¯å’Œæ¯”è¾ƒä¸åŒç‰ˆæœ¬çš„è®°å¿†ã€‚
    *   **æ·˜æ±°æœºåˆ¶ï¼š** æ ¹æ®è®°å¿†çš„ä½¿ç”¨é¢‘ç‡ã€æ—¶æ•ˆæ€§ç­‰ç­–ç•¥ï¼Œå®šæœŸæ·˜æ±°ä½ä»·å€¼è®°å¿†ã€‚
    *   **è¯„ä¼°ä¸ä¼˜åŒ–ï¼š** å®šæœŸè¯„ä¼°è®°å¿†çš„è´¨é‡å’Œæœ‰æ•ˆæ€§ï¼Œé€šè¿‡äººå·¥æ ‡æ³¨æˆ–Agentè‡ªè¯„ä¼°æ¥ä¼˜åŒ–è®°å¿†ç”Ÿæˆç­–ç•¥ã€‚

**äº”ã€æ¨¡å—é—´é€šä¿¡æœºåˆ¶**

1.  **åŒæ­¥é€šä¿¡ï¼š**
    *   **Agentæ ¸å¿ƒä¸å·¥å…·è°ƒç”¨ï¼š** ReAct Agent Coreé€šè¿‡Tool OrchestratoråŒæ­¥è°ƒç”¨å·¥å…·ï¼Œç­‰å¾…ç»“æœè¿”å›ã€‚
    *   **Agentæ ¸å¿ƒä¸è®°å¿†æ£€ç´¢ï¼š** Agentåœ¨æ¨ç†æ—¶åŒæ­¥è°ƒç”¨Memory Retrieverè·å–ç›¸å…³è®°å¿†ã€‚

2.  **å¼‚æ­¥é€šä¿¡ï¼š**
    *   **è®°å¿†ç”Ÿæˆï¼š** å·¥å…·è°ƒç”¨ç»“æœå’Œä»»åŠ¡å®Œæˆäº‹ä»¶é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å‘é€ç»™Memory Generatorï¼Œé¿å…é˜»å¡Agentæ ¸å¿ƒã€‚
    *   **è®°å¿†æ›´æ–°ï¼š** Memory Updaterå¯¹è®°å¿†çš„å»é‡ã€åˆå¹¶ã€æ·˜æ±°ç­‰æ“ä½œå¯ä»¥å¼‚æ­¥è¿›è¡Œã€‚

**å…­ã€æŒç»­ä¼˜åŒ–ä¸è¿›åŒ–**

1.  **A/Bæµ‹è¯•ï¼š** å¯¹ä¸åŒçš„è®°å¿†ç”Ÿæˆç­–ç•¥ã€æ£€ç´¢ç®—æ³•è¿›è¡ŒA/Bæµ‹è¯•ï¼Œè¯„ä¼°æ•ˆæœã€‚
2.  **äººå·¥åé¦ˆï¼š** å¼•å…¥äººå·¥æ ‡æ³¨å’Œåé¦ˆæœºåˆ¶ï¼Œå¯¹Agentçš„å†³ç­–å’Œè®°å¿†è´¨é‡è¿›è¡Œç›‘ç£å’Œä¿®æ­£ã€‚
3.  **è‡ªç›‘ç£å­¦ä¹ ï¼š** Agentå¯ä»¥æ ¹æ®ä»»åŠ¡çš„æˆåŠŸç‡ã€æ•ˆç‡ç­‰æŒ‡æ ‡ï¼Œè‡ªæˆ‘è¯„ä¼°è®°å¿†çš„æœ‰æ•ˆæ€§ï¼Œå¹¶è°ƒæ•´è®°å¿†ç”Ÿæˆå’Œåˆ©ç”¨ç­–ç•¥ã€‚
4.  **é¢†åŸŸé€‚åº”ï¼š** é’ˆå¯¹ç‰¹å®šé¢†åŸŸï¼Œé€šè¿‡é¢†åŸŸçŸ¥è¯†æ³¨å…¥å’Œå¾®è°ƒï¼ŒåŠ é€ŸAgentåœ¨è¯¥é¢†åŸŸçš„ä¸“ä¸šåŒ–è¿›ç¨‹ã€‚

**ä¸ƒã€å…·ä½“çš„ä»£ç å®ç°ç¤ºä¾‹ (Python)**

ä»¥ä¸‹æä¾›ä¸€ä¸ªç®€åŒ–çš„Pythonä»£ç ç¤ºä¾‹ï¼Œå±•ç¤ºæ ¸å¿ƒæ¨¡å—çš„å®ç°æ€è·¯ã€‚è¿™åªæ˜¯ä¸€ä¸ªæ¦‚å¿µéªŒè¯ï¼Œå®é™…ç”Ÿäº§ç¯å¢ƒéœ€è¦æ›´å®Œå–„çš„é”™è¯¯å¤„ç†ã€å¹¶å‘æ§åˆ¶ã€æŒä¹…åŒ–å­˜å‚¨ç­‰ã€‚

```python
import uuid
import time
from typing import Dict, Any, List, Callable, Optional

# --- 1. LLM Client (æ¨¡æ‹Ÿ) ---
class MockLLMClient:
    """æ¨¡æ‹ŸLLMå®¢æˆ·ç«¯ï¼Œç”¨äºç”ŸæˆThoughtã€Actionå’ŒMemoryã€‚"""
    def generate(self, prompt: str, **kwargs) -> str:
        print(f"--- LLM Generating with Prompt ---\n{prompt}\n--------------------------------")
        # å®é™…åº”ç”¨ä¸­è¿™é‡Œä¼šè°ƒç”¨çœŸå®çš„LLM API
        if "Thought:" in prompt and "Action:" in prompt:
            # æ¨¡æ‹ŸReAct Agentçš„è¾“å‡º
            if "Playbookä¸­çš„æ‰€æœ‰ä»»åŠ¡éƒ½å·²å®Œæˆ" in prompt:
                return "Thought: æ‰€æœ‰å¿…è¦çš„ä»»åŠ¡å‡å·²å®Œæˆã€‚æˆ‘å·²ç»æ”¶é›†åˆ°äº†è¶³å¤Ÿçš„ä¿¡æ¯ï¼Œç°åœ¨å¯ä»¥ç”Ÿæˆæœ€ç»ˆç­”æ¡ˆã€‚\nAnswer: è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿçš„æœ€ç»ˆç­”æ¡ˆï¼ŒåŸºäºæ‰€æœ‰å·²å®Œæˆçš„ä»»åŠ¡å’Œè§‚å¯Ÿç»“æœã€‚"
            elif "serper_search" in prompt:
                return "Thought: æˆ‘éœ€è¦æœç´¢æœ€æ–°çš„ä¿¡æ¯æ¥å›ç­”ç”¨æˆ·é—®é¢˜ã€‚ä¸ºäº†å®ç°è¿™ä¸ªç›®æ ‡ï¼Œæˆ‘éœ€è¦è°ƒç”¨ serper_search å·¥å…·æ¥è·å–ç›¸å…³ç½‘é¡µå†…å®¹ã€‚\nAction: serper_search\nAction Input: {\"query\": \"æœ€æ–°ç§‘æŠ€æ–°é—»\"}"
            elif "web_crawler" in prompt:
                return "Thought: æˆ‘å·²ç»æ‰¾åˆ°äº†ä¸€ä¸ªç›¸å…³çš„ç½‘é¡µé“¾æ¥ï¼Œç°åœ¨éœ€è¦çˆ¬å–å…¶å†…å®¹ã€‚ä¸ºäº†å®ç°è¿™ä¸ªç›®æ ‡ï¼Œæˆ‘éœ€è¦è°ƒç”¨ web_crawler å·¥å…·æ¥è·å–ç½‘é¡µæ­£æ–‡ã€‚\nAction: web_crawler\nAction Input: {\"url\": \"https://example.com/news\", \"need_summary\": true}"
            else:
                return "Thought: æˆ‘éœ€è¦æ‰§è¡Œä¸€ä¸ªPythonä»£ç ç‰‡æ®µã€‚ä¸ºäº†å®ç°è¿™ä¸ªç›®æ ‡ï¼Œæˆ‘éœ€è¦è°ƒç”¨ python_execute å·¥å…·æ¥è¿è¡Œä»£ç ã€‚\nAction: python_execute\nAction Input: {\"code\": \"print('Hello from Python!')\", \"language\": \"python\", \"enable_network\": false}"
        elif "æ€»ç»“è°ƒç”¨æ­¤å·¥å…·çš„æ ¸å¿ƒè¦ç‚¹" in prompt:
            return f"Tool Memory: æ ¸å¿ƒè¦ç‚¹ - {kwargs.get('tool_name', 'unknown')} è¢«è°ƒç”¨ä»¥å¤„ç† {kwargs.get('query', 'æœªçŸ¥æŸ¥è¯¢')}ï¼Œç»“æœæ˜¯ {kwargs.get('observation', 'æ— ')[:50]}..."
        elif "æç‚¼é—®é¢˜è§£å†³çš„æ ‡å‡†æµç¨‹" in prompt:
            return f"SOP Memory: è§£å†³ {kwargs.get('query', 'æœªçŸ¥é—®é¢˜')} çš„æ ‡å‡†æµç¨‹ï¼š{kwargs.get('playbook', 'æ— å‰§æœ¬')} -> {kwargs.get('answer', 'æ— ç­”æ¡ˆ')[:50]}..."
        return "Mock LLM Response."

# --- 2. Tool Registry and Orchestrator (ç®€åŒ–ç‰ˆ) ---
class Tool:
    def __init__(self, name: str, description: str, parameters: Dict, func: Callable):
        self.name = name
        self.description = description
        self.parameters = parameters
        self.func = func

    def __call__(self, **kwargs) -> Dict:
        try:
            result = self.func(**kwargs)
            return {"result": result, "success": True}
        except Exception as e:
            return {"stderr": str(e), "success": False}

class ToolOrchestrator:
    def __init__(self):
        self.tools: Dict[str, Tool] = {}

    def register_tool(self, tool: Tool):
        self.tools[tool.name] = tool

    def get_tool_description(self) -> str:
        descriptions = []
        for name, tool in self.tools.items():
            descriptions.append(f"## {tool.name}\n**Description**: {tool.description}\n**Parameters**: {tool.parameters}")
        return "\n\n".join(descriptions)

    def execute_tool(self, tool_name: str, tool_input: Dict) -> Dict:
        if tool_name not in self.tools:
            return {"stderr": f"Tool '{tool_name}' not found.", "success": False}
        print(f"Executing tool: {tool_name} with input: {tool_input}")
        return self.tools[tool_name](**tool_input)

# --- 3. Memory Store (ç®€åŒ–ç‰ˆï¼Œå†…å­˜å­˜å‚¨) ---
class MemoryStore:
    def __init__(self):
        self.tool_memories: List[Dict] = []
        self.sop_memories: List[Dict] = []
        # å®é™…åº”ç”¨ä¸­ä¼šä½¿ç”¨å‘é‡æ•°æ®åº“è¿›è¡Œè¯­ä¹‰æ£€ç´¢
        self.vector_db_mock = {} # {embedding_vector: memory_content}

    def add_tool_memory(self, memory_content: str, query: str, tool_name: str, observation: str):
        memory = {
            "id": str(uuid.uuid4()),
            "type": "tool",
            "content": memory_content,
            "query": query,
            "tool_name": tool_name,
            "observation": observation,
            "timestamp": time.time()
        }
        self.tool_memories.append(memory)
        # æ¨¡æ‹Ÿå‘é‡å­˜å‚¨
        self.vector_db_mock[hash(memory_content) % 1000] = memory # ç®€åŒ–å“ˆå¸Œä½œä¸ºembedding
        print(f"Added Tool Memory: {memory_content[:100]}...")

    def add_sop_memory(self, memory_content: str, query: str, playbook: str, answer: str):
        memory = {
            "id": str(uuid.uuid4()),
            "type": "sop",
            "content": memory_content,
            "query": query,
            "playbook": playbook,
            "answer": answer,
            "timestamp": time.time()
        }
        self.sop_memories.append(memory)
        # æ¨¡æ‹Ÿå‘é‡å­˜å‚¨
        self.vector_db_mock[hash(memory_content) % 1000] = memory
        print(f"Added SOP Memory: {memory_content[:100]}...")

    def retrieve_tool_memories(self, query: str, top_k: int = 3) -> List[Dict]:
        # å®é™…åº”ç”¨ä¸­ä¼šè¿›è¡Œè¯­ä¹‰ç›¸ä¼¼åº¦æ£€ç´¢
        print(f"Retrieving Tool Memories for query: {query}")
        # æ¨¡æ‹Ÿæ£€ç´¢ï¼Œè¿”å›æœ€è¿‘çš„kä¸ª
        return sorted(self.tool_memories, key=lambda x: x['timestamp'], reverse=True)[:top_k]

    def retrieve_sop_memories(self, query: str, top_k: int = 1) -> List[Dict]:
        # å®é™…åº”ç”¨ä¸­ä¼šè¿›è¡Œè¯­ä¹‰ç›¸ä¼¼åº¦æ£€ç´¢
        print(f"Retrieving SOP Memories for query: {query}")
        # æ¨¡æ‹Ÿæ£€ç´¢ï¼Œè¿”å›æœ€è¿‘çš„kä¸ª
        return sorted(self.sop_memories, key=lambda x: x['timestamp'], reverse=True)[:top_k]

# --- 4. Prompt Manager ---
class PromptManager:
    def __init__(self):
        self.prompts = {
            "tool_memory_prompt": """
                ä½ æ˜¯ä¸€ä¸ªå·¥å…·é€‰æ‹©ä¸“å®¶ã€‚
                æ ¹æ®å·¥å…·è°ƒç”¨è¯¦æƒ…ï¼š`{tool_invoke_text}` å’Œç”¨æˆ·é—®é¢˜ï¼š`{query}`ï¼Œæ€»ç»“è°ƒç”¨æ­¤å·¥å…·çš„æ ¸å¿ƒè¦ç‚¹ã€‚
                è¾“å‡ºï¼šç”Ÿæˆå¹¶è¾“å‡ºå·¥å…·è°ƒç”¨çš„æ ¸å¿ƒè¦ç‚¹ã€‚
            """,
            "sop_memory_prompt": """
                ä½ æ˜¯ä¸€ä¸ªæµç¨‹æç‚¼ä¸“å®¶ã€‚
                æ ¹æ®ç”¨æˆ·é—®é¢˜ï¼š`{query}`ã€å‰§æœ¬ï¼š`{playbook}` å’Œæœ€ç»ˆç»“æœï¼š`{answer}`ï¼Œæç‚¼é—®é¢˜è§£å†³çš„æ ‡å‡†æµç¨‹ã€‚
                æµç¨‹ç‰¹ç‚¹ï¼šè¿™æ˜¯ä¸€ä¸ªæŒ‡å¯¼æ€§çš„ã€æ¦‚æ‹¬æ€§çš„æ–‡æœ¬ï¼Œä¸æ¶‰åŠå…·ä½“çš„å·¥å…·è°ƒç”¨ã€‚
                è¾“å‡ºï¼šè§£å†³ç”¨æˆ·é—®é¢˜çš„æ ‡å‡†æµç¨‹ã€‚
            """,
            "react_agent_prompt_template": """
                # ğŸ“œ ä½¿å‘½ä¸èº«ä»½
                ä½ æ˜¯ Proteusï¼Œä¸€ä¸ªç”±å¤§å‹è¯­è¨€æ¨¡å‹é©±åŠ¨çš„ã€åŸºäº ReAct èŒƒå¼çš„é¡¶å°–æ™ºèƒ½ä»£ç†ã€‚
                ä½ çš„æ ¸å¿ƒä½¿å‘½æ˜¯ç²¾ç¡®ã€é«˜æ•ˆåœ°å®Œæˆå¤æ‚ä»»åŠ¡ã€‚

                ---

                # ğŸŒŸ Playbookï¼šä»»åŠ¡æ‰§è¡Œçš„å”¯ä¸€å‰§æœ¬
                **Playbook æ˜¯æ•´ä¸ªä»»åŠ¡çš„æ ¸å¿ƒï¼Œæ˜¯ä½ æ‰€æœ‰æ€è€ƒå’Œè¡ŒåŠ¨çš„å”¯ä¸€ä¾æ®å’Œæœ€ç»ˆæŒ‡å—ã€‚** å®ƒåŒ…å«äº†ä¸ºäº†å®Œæˆæœ€ç»ˆç›®æ ‡è€Œå¿…é¡»æ‰§è¡Œçš„æ‰€æœ‰å­ä»»åŠ¡åˆ—è¡¨ã€‚

                - **æ ¸å¿ƒåœ°ä½**: Playbook æ˜¯ä»»åŠ¡çš„â€œå”¯ä¸€äº‹å®æ¥æºâ€ï¼ˆSingle Source of Truthï¼‰ã€‚ä½ **å¿…é¡»**ä¸¥æ ¼æŒ‰ç…§ Playbook çš„æŒ‡å¼•ï¼Œä¾æ¬¡å®Œæˆå…¶ä¸­å®šä¹‰çš„æ¯ä¸€ä¸ªå­ä»»åŠ¡ã€‚
                - **å†³ç­–ä¾æ®**: ä½ çš„æ¯ä¸€æ­¥æ¨ç†ï¼ˆThoughtï¼‰å’Œå·¥å…·è°ƒç”¨ï¼ˆActionï¼‰éƒ½**å¿…é¡»**ä»¥ Playbook ä¸­çš„å¾…åŠä»»åŠ¡ä¸ºå‡ºå‘ç‚¹ã€‚
                - **ä»»åŠ¡æ­¥éª¤**: æ¯ä¸€ä¸ªå¾…åŠä»»åŠ¡éƒ½å¯èƒ½ä¼šéœ€è¦å¤šæ­¥å·¥å…·è°ƒç”¨æ‰èƒ½å®ç°ï¼Œè¯·ä»”ç»†å®¡è§†å¾…åŠé¡¹æ˜¯å¦çœŸçš„å®Œæˆã€‚
                - **å®Œæˆæ ‡å¿—**: åªæœ‰å½“ Playbook ä¸­æ‰€æœ‰çš„ä»»åŠ¡éƒ½æ ‡è®°ä¸ºå®Œæˆæ—¶ï¼Œä½ æ‰èƒ½è®¤ä¸ºæœ€ç»ˆç›®æ ‡å·²è¾¾æˆï¼Œå¹¶å¯ä»¥ç”Ÿæˆæœ€ç»ˆç­”æ¡ˆï¼ˆAnswerï¼‰ã€‚

                ---

                # ğŸ¯ æ ¸å¿ƒå·¥ä½œæµï¼šReAct å¾ªç¯
                ä½ é€šè¿‡ã€ŒThought -> Action -> Observationã€çš„è¿­ä»£å¾ªç¯æ¥è§£å†³é—®é¢˜ã€‚æ¯ä¸€æ¬¡å¾ªç¯éƒ½å¿…é¡»ä¸¥æ ¼éµå¾ªä»¥ä¸‹æŒ‡å¼•ï¼š

                1.  **ç¬¬ä¸€æ­¥ï¼šèšç„¦ Playbook**
                    - åœ¨æ¯ä¸€æ¬¡å¾ªç¯å¼€å§‹æ—¶ï¼Œ**å¿…é¡»**é¦–å…ˆå®¡è§†å½“å‰çš„ `Playbook`ï¼Œè¯†åˆ«å‡ºä¸‹ä¸€ä¸ªéœ€è¦æ‰§è¡Œçš„å­ä»»åŠ¡ã€‚

                2.  **ç¬¬äºŒæ­¥ï¼šæ€è€ƒï¼ˆThoughtï¼‰**
                    - åŸºäºå½“å‰éœ€è¦å®Œæˆçš„ä»»åŠ¡ï¼Œè¿›è¡Œç®€æ˜æ‰¼è¦çš„æ¨ç†ã€‚è¯´æ˜ä½ ä¸ºä»€ä¹ˆé€‰æ‹©æŸä¸ªå·¥å…·æ¥å®Œæˆè¿™ä¸ªç‰¹å®šçš„ä»»åŠ¡ã€‚
                    - **æ³¨æ„**: åœ¨ Thought ä¸­åªéœ€è¦æè¿°è¦å®Œæˆçš„äº‹æƒ…å’Œé€‰æ‹©å·¥å…·çš„ç†ç”±ï¼Œä¸è¦æåŠ Playbook æˆ–å…¶ä»–å‚è€ƒå†…å®¹ã€‚

                3.  **ç¬¬ä¸‰æ­¥ï¼šè¡ŒåŠ¨ï¼ˆActionï¼‰**
                    - **ç²¾å‡†é€‰å‹**: ä»ä¸‹æ–¹ `å¯ç”¨å·¥å…·åˆ—è¡¨` ä¸­é€‰æ‹©æœ€é€‚åˆå½“å‰å­ä»»åŠ¡çš„å·¥å…·ã€‚
                    - **åŸå­æ“ä½œ**: æ¯æ¬¡å¾ªç¯**åªèƒ½**è°ƒç”¨ä¸€ä¸ªå·¥å…·ã€‚

                4.  **ç¬¬å››æ­¥ï¼šè§‚å¯Ÿï¼ˆObservationï¼‰**
                    - ç³»ç»Ÿä¼šè¿”å›å·¥å…·æ‰§è¡Œçš„ç»“æœï¼Œè¿™æ˜¯ä½ è¿›è¡Œä¸‹ä¸€æ­¥å†³ç­–çš„å…³é”®ä¿¡æ¯ã€‚

                5.  **å¾ªç¯ä¸ç»ˆæ­¢**
                    - **è¿­ä»£**: æŒç»­è¿™ä¸ªå¾ªç¯ï¼Œç›´åˆ° `Playbook` ä¸­çš„æ‰€æœ‰ä»»åŠ¡éƒ½å®Œæˆã€‚
                    - **ç»ˆæ­¢**: å½“ `Playbook` å®Œæˆåï¼Œè¿›å…¥â€œæœ€ç»ˆç­”æ¡ˆæ¨¡å¼â€ï¼Œæ€»ç»“æ‰€æœ‰ `Observation`ï¼Œå¹¶å‚ç…§ `Playbook` çš„ç›®æ ‡ç»™å‡ºæœ€ç»ˆç­”æ¡ˆã€‚
                    - **ç”¨æˆ·å¹²é¢„**: å¦‚æœå·¥å…·æ‰§è¡Œå¤šæ¬¡å¤±è´¥æˆ–é™·å…¥å›°å¢ƒï¼Œåº”ä¸»åŠ¨å‘ç”¨æˆ·æ±‚åŠ©ã€‚

                ---

                # ğŸ› ï¸ å¯ç”¨å·¥å…·åˆ—è¡¨
                {tool_descriptions}

                ---

                # âš¡ è¾“å‡ºæ ¼å¼è§„èŒƒï¼ˆè‡³å…³é‡è¦ï¼‰
                ä½ **å¿…é¡»**ä¸¥æ ¼éµå¾ªä»¥ä¸‹ä¸¤ç§æ ¼å¼ä¹‹ä¸€è¿›è¡Œè¾“å‡ºï¼Œä¸å¾—æœ‰ä»»ä½•åå·®ã€‚

                ## æ ¼å¼ä¸€ï¼šå·¥å…·è°ƒç”¨æ¨¡å¼
                ```
                Thought: æˆ‘éœ€è¦ `[æè¿°è¦å®Œæˆçš„äº‹æƒ…]`ã€‚ä¸ºäº†å®ç°è¿™ä¸ªç›®æ ‡ï¼Œæˆ‘éœ€è¦è°ƒç”¨ `[å·¥å…·åç§°]` å·¥å…·æ¥ `[è¯´æ˜åŸå› ]`ã€‚
                Action: [å·¥å…·åç§°]
                Action Input: {{"å‚æ•°å": "å‚æ•°å€¼", ...}}
                ```

                ## æ ¼å¼äºŒï¼šæœ€ç»ˆç­”æ¡ˆæ¨¡å¼
                ```
                Thought: æ‰€æœ‰å¿…è¦çš„ä»»åŠ¡å‡å·²å®Œæˆã€‚æˆ‘å·²ç»æ”¶é›†åˆ°äº†è¶³å¤Ÿçš„ä¿¡æ¯ï¼Œç°åœ¨å¯ä»¥ç”Ÿæˆæœ€ç»ˆç­”æ¡ˆã€‚
                Answer: [ç›´æ¥ç»™å‡ºä¸€ä¸ªè¯¦å°½ã€å®Œæ•´ã€åŒ…å«å…³é”®ä¿¡æ¯çš„æœ€ç»ˆç­”æ¡ˆï¼Œåªè¾“å‡ºæ»¡è¶³ç”¨æˆ·é—®é¢˜çš„ç­”æ¡ˆå†…å®¹ï¼Œä¸è¦æåŠå‚è€ƒäº†ä»€ä¹ˆå†…å®¹æˆ–å®Œæˆäº†ä»€ä¹ˆä»»åŠ¡ã€‚]
                ```

                ---

                # ğŸ“ å…³é”®ä¸Šä¸‹æ–‡ä¿¡æ¯
                - **è¡Œä¸ºæŒ‡å¼•**: 
                - **é™„åŠ ä¸Šä¸‹æ–‡**: æš‚æ— 
                - **å½“å‰æ—¶é—´**: {current_time}

                ---

                # ğŸš€ å¼€å§‹æ‰§è¡Œ

                ## Playbook (ä»»åŠ¡å‰§æœ¬)
                {playbook}

                ## å†å²äº¤äº’è®°å½•
                {history}
                """
        }

    def get_prompt(self, name: str, **kwargs) -> str:
        template = self.prompts.get(name)
        if not template:
            raise ValueError(f"Prompt '{name}' not found.")
        return template.format(**kwargs)

# --- 5. ReAct Agent Core ---
class ReActAgent:
    def __init__(self, llm_client: MockLLMClient, tool_orchestrator: ToolOrchestrator,
                 memory_store: MemoryStore, prompt_manager: PromptManager):
        self.llm_client = llm_client
        self.tool_orchestrator = tool_orchestrator
        self.memory_store = memory_store
        self.prompt_manager = prompt_manager
        self.history: List[str] = []
        self.playbook: Dict = {
            "ç¬¬ä¸€éƒ¨åˆ†ï¼šä»»åŠ¡è§„åˆ’ä¸å®Œæˆåº¦": {"ä»»åŠ¡åˆ—è¡¨": [], "å…³è”æ€§åˆ¤æ–­": "", "çŠ¶æ€æ›´æ–°": {}},
            "ç¬¬äºŒéƒ¨åˆ†ï¼šå…³é”®ä¿¡æ¯æ±‡æ€»": {},
            "ç¬¬ä¸‰éƒ¨åˆ†ï¼šå®Œæ•´è°ƒç”¨è¿‡ç¨‹": []
        }
        self.current_query: str = ""
        self.final_answer: Optional[str] = None

    def _update_playbook_status(self, task_description: str, status: bool = True):
        # ç®€åŒ–æ›´æ–°é€»è¾‘ï¼Œå®é™…å¯èƒ½éœ€è¦æ›´å¤æ‚çš„åŒ¹é…
        for i, task in enumerate(self.playbook["ç¬¬ä¸€éƒ¨åˆ†ï¼šä»»åŠ¡è§„åˆ’ä¸å®Œæˆåº¦"]["ä»»åŠ¡åˆ—è¡¨"]):
            if task_description in task:
                if status:
                    self.playbook["ç¬¬ä¸€éƒ¨åˆ†ï¼šä»»åŠ¡è§„åˆ’ä¸å®Œæˆåº¦"]["ä»»åŠ¡åˆ—è¡¨"][i] = task.replace("[ ]", "[x]")
                else:
                    self.playbook["ç¬¬ä¸€éƒ¨åˆ†ï¼šä»»åŠ¡è§„åˆ’ä¸å®Œæˆåº¦"]["ä»»åŠ¡åˆ—è¡¨"][i] = task.replace("[x]", "[ ]")
                break
        # çŠ¶æ€æ›´æ–°ä¹Ÿéœ€è¦åŒæ­¥
        self.playbook["ç¬¬ä¸€éƒ¨åˆ†ï¼šä»»åŠ¡è§„åˆ’ä¸å®Œæˆåº¦"]["çŠ¶æ€æ›´æ–°"][task_description] = "[x]" if status else "[ ]"

    def _parse_llm_output(self, output: str) -> Dict[str, Any]:
        thought_match = re.search(r"Thought: (.*)", output)
        action_match = re.search(r"Action: (\w+)", output)
        action_input_match = re.search(r"Action Input: (\{.*\})", output, re.DOTALL)
        answer_match = re.search(r"Answer: (.*)", output, re.DOTALL)

        parsed = {}
        if thought_match:
            parsed["thought"] = thought_match.group(1).strip()
        if action_match:
            parsed["action"] = action_match.group(1).strip()
        if action_input_match:
            try:
                parsed["action_input"] = json.loads(action_input_match.group(1).strip())
            except json.JSONDecodeError:
                print(f"Warning: Could not parse Action Input JSON: {action_input_match.group(1)}")
                parsed["action_input"] = {}
        if answer_match:
            parsed["answer"] = answer_match.group(1).strip()
        return parsed

    def run(self, initial_query: str, initial_playbook_tasks: List[str]):
        self.current_query = initial_query
        self.playbook["ç¬¬ä¸€éƒ¨åˆ†ï¼šä»»åŠ¡è§„åˆ’ä¸å®Œæˆåº¦"]["ä»»åŠ¡åˆ—è¡¨"] = [f"[ ] {task}" for task in initial_playbook_tasks]
        self.playbook["ç¬¬ä¸€éƒ¨åˆ†ï¼šä»»åŠ¡è§„åˆ’ä¸å®Œæˆåº¦"]["çŠ¶æ€æ›´æ–°"] = {task: "[ ]" for task in initial_playbook_tasks}
        self.playbook["ç¬¬äºŒéƒ¨åˆ†ï¼šå…³é”®ä¿¡æ¯æ±‡æ€»"]["ç”¨æˆ·é—®é¢˜"] = initial_query

        print(f"Agent started with query: {initial_query}")
        print(f"Initial Playbook: {self.playbook['ç¬¬ä¸€éƒ¨åˆ†ï¼šä»»åŠ¡è§„åˆ’ä¸å®Œæˆåº¦']['ä»»åŠ¡åˆ—è¡¨']}")

        max_iterations = 10 # é˜²æ­¢æ— é™å¾ªç¯
        iteration = 0

        while iteration < max_iterations:
            iteration += 1
            print(f"\n--- Iteration {iteration} ---")

            # 1. èšç„¦ Playbookï¼Œè¯†åˆ«ä¸‹ä¸€ä¸ªå¾…æ‰§è¡Œä»»åŠ¡
            next_task = None
            for task_item in self.playbook["ç¬¬ä¸€éƒ¨åˆ†ï¼šä»»åŠ¡è§„åˆ’ä¸å®Œæˆåº¦"]["ä»»åŠ¡åˆ—è¡¨"]:
                if "[ ]" in task_item:
                    next_task = task_item.replace("[ ] ", "")
                    break
            
            if not next_task and not self.final_answer: # æ‰€æœ‰ä»»åŠ¡éƒ½å®Œæˆäº†ï¼Œè¿›å…¥æœ€ç»ˆç­”æ¡ˆæ¨¡å¼
                print("All playbook tasks completed. Generating final answer.")
                prompt = self.prompt_manager.get_prompt(
                    "react_agent_prompt_template",
                    tool_descriptions=self.tool_orchestrator.get_tool_description(),
                    playbook=json.dumps(self.playbook, indent=2, ensure_ascii=False),
                    history="\n".join(self.history),
                    current_time=time.strftime("%Y-%m-%d %H:%M:%S")
                )
                llm_output = self.llm_client.generate(prompt)
                parsed_output = self._parse_llm_output(llm_output)
                if "answer" in parsed_output:
                    self.final_answer = parsed_output["answer"]
                    print(f"Final Answer: {self.final_answer}")
                    # ç”ŸæˆSOP Memory
                    sop_prompt = self.prompt_manager.get_prompt(
                        "sop_memory_prompt",
                        query=self.current_query,
                        playbook=json.dumps(self.playbook, indent=2, ensure_ascii=False),
                        answer=self.final_answer
                    )
                    sop_memory_content = self.llm_client.generate(sop_prompt, query=self.current_query, playbook=json.dumps(self.playbook, indent=2, ensure_ascii=False), answer=self.final_answer)
                    self.memory_store.add_sop_memory(sop_memory_content, self.current_query, json.dumps(self.playbook, indent=2, ensure_ascii=False), self.final_answer)
                    break # ä»»åŠ¡å®Œæˆï¼Œé€€å‡ºå¾ªç¯
                else:
                    print("Error: Expected final answer but got no answer from LLM.")
                    break

            if not next_task: # ç†è®ºä¸Šåº”è¯¥åœ¨ä¸Šé¢è¢«æ•è·ï¼Œè¿™é‡Œæ˜¯åŒé‡æ£€æŸ¥
                print("No pending tasks in playbook, but no final answer generated. Exiting.")
                break

            # 2. æ€è€ƒ (Thought) å’Œ 3. è¡ŒåŠ¨ (Action)
            current_prompt = self.prompt_manager.get_prompt(
                "react_agent_prompt_template",
                tool_descriptions=self.tool_orchestrator.get_tool_description(),
                playbook=json.dumps(self.playbook, indent=2, ensure_ascii=False),
                history="\n".join(self.history),
                current_time=time.strftime("%Y-%m-%d %H:%M:%S")
            )
            llm_output = self.llm_client.generate(current_prompt)
            parsed_output = self._parse_llm_output(llm_output)

            if "thought" in parsed_output:
                print(f"Thought: {parsed_output['thought']}")
                self.history.append(f"Thought: {parsed_output['thought']}")
            else:
                print("Error: LLM did not provide a Thought. Exiting.")
                break

            if "action" in parsed_output and "action_input" in parsed_output:
                tool_name = parsed_output["action"]
                tool_input = parsed_output["action_input"]
                print(f"Action: {tool_name}")
                print(f"Action Input: {tool_input}")
                self.history.append(f"Action: {tool_name}")
                self.history.append(f"Action Input: {tool_input}")

                # 4. è§‚å¯Ÿ (Observation)
                tool_result = self.tool_orchestrator.execute_tool(tool_name, tool_input)
                observation = tool_result.get("result") or tool_result.get("stderr")
                success = tool_result.get("success", False)
                print(f"Observation: {observation}")
                self.history.append(f"Observation: {observation}")
                self.playbook["ç¬¬ä¸‰éƒ¨åˆ†ï¼šå®Œæ•´è°ƒç”¨è¿‡ç¨‹"].append({
                    "thought": parsed_output['thought'],
                    "action": tool_name,
                    "action_input": tool_input,
                    "observation": observation,
                    "success": success
                })

                # ç”ŸæˆTool Memory
                tool_invoke_text = f"Tool: {tool_name}, Input: {tool_input}, Output: {observation}"
                tool_memory_prompt = self.prompt_manager.get_prompt(
                    "tool_memory_prompt",
                    tool_invoke_text=tool_invoke_text,
                    query=self.current_query,
                    tool_name=tool_name,
                    observation=observation
                )
                tool_memory_content = self.llm_client.generate(tool_memory_prompt, tool_invoke_text=tool_invoke_text, query=self.current_query, tool_name=tool_name, observation=observation)
                self.memory_store.add_tool_memory(tool_memory_content, self.current_query, tool_name, observation)

                # æ›´æ–°PlaybookçŠ¶æ€ (ç®€åŒ–é€»è¾‘ï¼Œå®é™…éœ€è¦æ›´æ™ºèƒ½çš„åˆ¤æ–­)
                if success:
                    self._update_playbook_status(next_task, True)
                else:
                    print(f"Tool '{tool_name}' failed. Consider re-trying or asking for user input.")
                    # å®é™…ä¸­å¯èƒ½éœ€è¦æ›´å¤æ‚çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
                    break # ç®€åŒ–å¤„ç†ï¼Œå·¥å…·å¤±è´¥åˆ™é€€å‡º

            else:
                print("Error: LLM did not provide a valid Action. Exiting.")
                break
        
        if not self.final_answer:
            print("Agent finished without generating a final answer (max iterations reached or error).")
        
        return self.final_answer, self.playbook

# --- è¾…åŠ©å·¥å…·å‡½æ•° ---
def mock_python_execute(code: str, language: str, enable_network: bool, variables: Dict = {}) -> str:
    if language == "python":
        try:
            # æ¨¡æ‹ŸPythonæ‰§è¡Œç¯å¢ƒ
            _globals = {"print": lambda x: x, **variables} # ç®€åŒ–printï¼Œå¹¶æ³¨å…¥å˜é‡
            _locals = {}
            exec(code, _globals, _locals)
            return _globals.get("result", "Python code executed successfully (mock).")
        except Exception as e:
            return f"Python execution error: {e}"
    elif language == "shell":
        return f"Shell command '{code}' executed successfully (mock)."
    return "Unsupported language."

def mock_serper_search(query: str, country: str = "cn", language: str = "zh", max_results: int = 10) -> str:
    return f"Mock search results for '{query}': [Link1 - Summary1], [Link2 - Summary2]"

def mock_web_crawler(url: str, need_summary: bool = False, include_markdown: bool = False) -> str:
    if "example.com/news" in url:
        return "Mock content from example.com/news: This is a summary of the news article." if need_summary else "Full article content from example.com/news."
    return f"Mock content for {url}."

def mock_user_input(prompt: str, input_type: str, default_value: Optional[str] = None, validation: Dict = {}) -> str:
    print(f"User Input Request: {prompt} (Type: {input_type})")
    return default_value if default_value else "Mock user input."

# --- ç³»ç»Ÿåˆå§‹åŒ–ä¸è¿è¡Œ ---
if __name__ == "__main__":
    import json
    import re

    # åˆå§‹åŒ–æ ¸å¿ƒç»„ä»¶
    llm_client = MockLLMClient()
    tool_orchestrator = ToolOrchestrator()
    memory_store = MemoryStore()
    prompt_manager = PromptManager()

    # æ³¨å†Œå·¥å…·
    tool_orchestrator.register_tool(Tool("python_execute", "é€šç”¨ä»£ç æ‰§è¡ŒèŠ‚ç‚¹", {"code": "str", "language": "str", "enable_network": "bool", "variables": "dict"}, mock_python_execute))
    tool_orchestrator.register_tool(Tool("serper_search", "Serperæœç´¢å¼•æ“èŠ‚ç‚¹", {"query": "str", "country": "str", "language": "str", "max_results": "int"}, mock_serper_search))
    tool_orchestrator.register_tool(Tool("web_crawler", "æ¥æ”¶URLå¹¶è¿”å›ç½‘é¡µæ­£æ–‡å†…å®¹çš„èŠ‚ç‚¹", {"url": "str", "need_summary": "bool", "include_markdown": "bool"}, mock_web_crawler))
    tool_orchestrator.register_tool(Tool("user_input", "ç”¨æˆ·è¾“å…¥èŠ‚ç‚¹", {"prompt": "str", "input_type": "str", "default_value": "str", "validation": "dict"}, mock_user_input))

    # åˆ›å»ºAgent
    agent = ReActAgent(llm_client, tool_orchestrator, memory_store, prompt_manager)

    # å®šä¹‰åˆå§‹ä»»åŠ¡
    initial_query = "è¯·å¸®æˆ‘æŸ¥æ‰¾å…³äº2024å¹´äººå·¥æ™ºèƒ½é¢†åŸŸæœ€æ–°çš„çªç ´æ€§è¿›å±•ï¼Œå¹¶æ€»ç»“å…¶ä¸»è¦å†…å®¹ã€‚"
    initial_playbook_tasks = [
        "ä½¿ç”¨æœç´¢å¼•æ“æŸ¥æ‰¾2024å¹´äººå·¥æ™ºèƒ½é¢†åŸŸçš„æœ€æ–°çªç ´æ€§è¿›å±•ã€‚",
        "æ ¹æ®æœç´¢ç»“æœï¼Œé€‰æ‹©è‡³å°‘3ç¯‡é«˜è´¨é‡æ–‡ç« è¿›è¡Œå†…å®¹çˆ¬å–å’Œæ€»ç»“ã€‚",
        "ç»¼åˆæ‰€æœ‰æ–‡ç« çš„æ€»ç»“ï¼Œæç‚¼å‡º2024å¹´äººå·¥æ™ºèƒ½é¢†åŸŸçš„ä¸»è¦çªç ´æ€§è¿›å±•ã€‚",
        "ç”Ÿæˆæœ€ç»ˆçš„æŠ¥å‘Šã€‚"
    ]

    # è¿è¡ŒAgent
    final_answer, final_playbook = agent.run(initial_query, initial_playbook_tasks)

    print("\n--- Agent Run Completed ---")
    print(f"Final Answer: {final_answer}")
    print("\n--- Final Playbook ---")
    print(json.dumps(final_playbook, indent=2, ensure_ascii=False))
    print("\n--- Stored Tool Memories ---")
    for mem in memory_store.tool_memories:
        print(f"- {mem['content']}")
    print("\n--- Stored SOP Memories ---")
    for mem in memory_store.sop_memories:
        print(f"- {mem['content']}")
```

**ä»£ç å®ç°è¯´æ˜ï¼š**

1.  **`MockLLMClient`ï¼š** æ¨¡æ‹Ÿäº†ä¸å¤§å‹è¯­è¨€æ¨¡å‹çš„äº¤äº’ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šæ›¿æ¢ä¸ºè°ƒç”¨OpenAIã€Anthropicæˆ–å…¶ä»–LLMæä¾›å•†çš„APIã€‚å®ƒæ ¹æ®è¾“å…¥æç¤ºè¯æ¨¡æ‹Ÿç”ŸæˆThought/Actionæˆ–Memoryå†…å®¹ã€‚
2.  **`Tool` å’Œ `ToolOrchestrator`ï¼š** `Tool` ç±»å°è£…äº†æ¯ä¸ªå·¥å…·çš„å…ƒæ•°æ®å’Œæ‰§è¡Œå‡½æ•°ã€‚`ToolOrchestrator` è´Ÿè´£æ³¨å†Œå’Œç®¡ç†æ‰€æœ‰å·¥å…·ï¼Œå¹¶æä¾›ç»Ÿä¸€çš„å·¥å…·æ‰§è¡Œæ¥å£ã€‚
3.  **`MemoryStore`ï¼š** ç®€åŒ–ç‰ˆçš„è®°å¿†å­˜å‚¨ï¼Œä½¿ç”¨Pythonåˆ—è¡¨æ¨¡æ‹Ÿå­˜å‚¨Tool Memoryå’ŒSOP Memoryã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿™ä¼šæ˜¯ä¸€ä¸ªä¸å‘é‡æ•°æ®åº“ï¼ˆå¦‚Pinecone, Weaviateï¼‰å’Œå…³ç³»å‹æ•°æ®åº“ï¼ˆå¦‚PostgreSQLï¼‰é›†æˆçš„æ¨¡å—ï¼Œç”¨äºé«˜æ•ˆçš„è¯­ä¹‰æ£€ç´¢å’ŒæŒä¹…åŒ–å­˜å‚¨ã€‚
4.  **`PromptManager`ï¼š** é›†ä¸­ç®¡ç†æ‰€æœ‰ç³»ç»Ÿæç¤ºè¯æ¨¡æ¿ï¼Œæ–¹ä¾¿åŠ¨æ€åŠ è½½å’Œæ ¼å¼åŒ–ã€‚
5.  **`ReActAgent`ï¼š** æ ¸å¿ƒAgenté€»è¾‘ï¼Œå®ç°äº†ReActå¾ªç¯ã€‚
    *   `run` æ–¹æ³•é©±åŠ¨æ•´ä¸ªä»»åŠ¡æ‰§è¡Œæµç¨‹ã€‚
    *   `_update_playbook_status` ç®€åŒ–äº†Playbookä»»åŠ¡çŠ¶æ€çš„æ›´æ–°ã€‚
    *   `_parse_llm_output` è§£æLLMçš„è¾“å‡ºï¼Œæå–Thoughtã€Actionã€Action Inputæˆ–Answerã€‚
    *   åœ¨æ¯æ¬¡å·¥å…·è°ƒç”¨åï¼Œä¼šè§¦å‘Tool Memoryçš„ç”Ÿæˆã€‚
    *   åœ¨ä»»åŠ¡å®Œæˆåï¼Œä¼šè§¦å‘SOP Memoryçš„ç”Ÿæˆã€‚
6.  **`mock_*` å‡½æ•°ï¼š** æ¨¡æ‹Ÿäº†å®é™…å·¥å…·ï¼ˆ`python_execute`, `serper_search`, `web_crawler`, `user_input`ï¼‰çš„åŠŸèƒ½ï¼Œä»¥ä¾¿åœ¨æ²¡æœ‰å®é™…å¤–éƒ¨ä¾èµ–çš„æƒ…å†µä¸‹è¿è¡Œç¤ºä¾‹ã€‚
7.  **ä¸»æ‰§è¡Œå— (`if __name__ == "__main__":`)ï¼š** æ¼”ç¤ºäº†å¦‚ä½•åˆå§‹åŒ–ç³»ç»Ÿç»„ä»¶ï¼Œæ³¨å†Œå·¥å…·ï¼Œåˆ›å»ºAgentï¼Œå¹¶è¿è¡Œä¸€ä¸ªç¤ºä¾‹ä»»åŠ¡ã€‚

**è¿›ä¸€æ­¥ä¼˜åŒ–å’Œå®Œå–„æ–¹å‘ï¼š**

*   **çœŸæ­£çš„LLMé›†æˆï¼š** å°†`MockLLMClient`æ›¿æ¢ä¸ºå®é™…çš„LLM APIè°ƒç”¨ã€‚
*   **å‘é‡æ•°æ®åº“é›†æˆï¼š** `MemoryStore`åº”ä¸å‘é‡æ•°æ®åº“ï¼ˆå¦‚`chromadb`, `faiss`, `pinecone`ç­‰ï¼‰é›†æˆï¼Œå®ç°é«˜æ•ˆçš„è¯­ä¹‰æ£€ç´¢ã€‚
*   **å¼‚æ­¥å¤„ç†ï¼š** ä½¿ç”¨`asyncio`å’Œæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¦‚`Celery` + `Redis/RabbitMQ`ï¼‰å®ç°è®°å¿†ç”Ÿæˆå’Œæ›´æ–°çš„å¼‚æ­¥åŒ–ï¼Œæé«˜Agentçš„å“åº”é€Ÿåº¦ã€‚
*   **é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶ï¼š** å¢åŠ æ›´å¥å£®çš„é”™è¯¯å¤„ç†ã€é‡è¯•ç­–ç•¥å’Œç”¨æˆ·å¹²é¢„æœºåˆ¶ã€‚
*   **Playbookçš„åŠ¨æ€ç”Ÿæˆä¸ä¼˜åŒ–ï¼š** å¼•å…¥LLMæ¥åŠ¨æ€ç”Ÿæˆå’Œä¼˜åŒ–Playbookï¼Œè€Œä¸ä»…ä»…æ˜¯é¢„è®¾ã€‚
*   **è®°å¿†çš„è¯„ä¼°ä¸æ·˜æ±°ï¼š** å®ç°è®°å¿†çš„è´¨é‡è¯„ä¼°å’ŒåŸºäºLRUã€LFUæˆ–è¯­ä¹‰ç›¸å…³æ€§çš„æ·˜æ±°ç­–ç•¥ã€‚
*   **ç”¨æˆ·ç•Œé¢/APIï¼š** æ„å»ºä¸€ä¸ªWebç•Œé¢æˆ–APIæ¥å£ï¼Œæ–¹ä¾¿ç”¨æˆ·ä¸Agentäº¤äº’ã€‚
*   **ç›‘æ§ä¸æ—¥å¿—ï¼š** å®Œå–„æ—¥å¿—è®°å½•å’Œç›‘æ§ç³»ç»Ÿï¼Œä»¥ä¾¿è¿½è¸ªAgentçš„è¡Œä¸ºå’Œæ€§èƒ½ã€‚
*   **å®‰å…¨æ€§ï¼š** ç‰¹åˆ«æ˜¯`python_execute`å·¥å…·ï¼Œéœ€è¦ä¸¥æ ¼çš„æ²™ç®±æœºåˆ¶æ¥é˜²æ­¢æ¶æ„ä»£ç æ‰§è¡Œã€‚