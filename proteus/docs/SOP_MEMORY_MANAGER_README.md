# SopMemoryManager - æ ‡å‡†é—®é¢˜è§£é¢˜ç»éªŒç®¡ç†å™¨

## æ¦‚è¿°

`SopMemoryManager` æ˜¯ä¸€ä¸ªåŸºäº `ToolMemoryManager` æ¶æ„è®¾è®¡çš„æ ‡å‡†æ“ä½œæµç¨‹ï¼ˆSOPï¼‰è®°å¿†ç®¡ç†å™¨ã€‚å®ƒä¸“é—¨ç”¨äºä»å®Œæ•´çš„é—®é¢˜è§£å†³è¿‡ç¨‹ä¸­æå–æ ‡å‡†åŒ–çš„è§£é¢˜ç»éªŒå’Œæœ€ä½³å®è·µï¼Œå¸®åŠ©AIç³»ç»Ÿåœ¨é¢å¯¹åŒç±»é—®é¢˜æ—¶èƒ½å¤Ÿæ›´é«˜æ•ˆã€æ›´å‡†ç¡®åœ°è§£å†³é—®é¢˜ã€‚

## æ ¸å¿ƒåŠŸèƒ½

### 1. SOPç»éªŒæå–
- ä»æˆåŠŸçš„é—®é¢˜è§£å†³è¿‡ç¨‹ä¸­æå–æ ‡å‡†è§£é¢˜æµç¨‹
- å…³æ³¨é—®é¢˜ç±»å‹ã€å·¥å…·è°ƒç”¨é“¾ã€æœ€ç»ˆç»“æœçš„å®Œæ•´å…³ç³»
- æå–å¯å¤ç”¨çš„æ ‡å‡†æ“ä½œæµç¨‹

### 2. æ™ºèƒ½é—®é¢˜ç±»å‹è¯†åˆ«
- è‡ªåŠ¨æ ¹æ®ç”¨æˆ·æŸ¥è¯¢å’Œå·¥å…·è°ƒç”¨é“¾æ¨æ–­é—®é¢˜ç±»å‹
- æ”¯æŒæ‰‹åŠ¨æŒ‡å®šé—®é¢˜ç±»å‹
- å†…ç½®å¸¸è§é—®é¢˜ç±»å‹åˆ†ç±»ï¼ˆä¿¡æ¯æ£€ç´¢ã€æ–‡ä»¶æ“ä½œã€æ•°æ®åˆ†æç­‰ï¼‰

### 3. è®°å¿†å­˜å‚¨ä¸æ£€ç´¢
- åŸºäºRedisçš„æŒä¹…åŒ–å­˜å‚¨
- æ”¯æŒç”¨æˆ·éš”ç¦»çš„è®°å¿†ç®¡ç†
- æä¾›æœç´¢å’Œæ‰¹é‡æ£€ç´¢åŠŸèƒ½

### 4. å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†
- SOPç»éªŒçš„åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤
- è¿‡æœŸæ—¶é—´ç®¡ç†
- è®°å¿†æ¸…ç†å’Œç»´æŠ¤

## ä¸»è¦ç‰¹æ€§

### ğŸ”„ åŸºäºToolMemoryManageræ¶æ„
- ç»§æ‰¿ToolMemoryManagerçš„ä¼˜ç§€è®¾è®¡æ¨¡å¼
- ä½¿ç”¨ç›¸åŒçš„Rediså­˜å‚¨æ¶æ„
- å…¼å®¹ç°æœ‰çš„æ—¥å¿—å’Œç›‘æ§ç³»ç»Ÿ

### ğŸ¯ é—®é¢˜ç±»å‹å¯¼å‘
- ä»¥é—®é¢˜ç±»å‹ä¸ºç´¢å¼•ç»„ç»‡SOPè®°å¿†
- æ”¯æŒé—®é¢˜ç±»å‹çš„è‡ªåŠ¨è¯†åˆ«å’Œæ‰‹åŠ¨æŒ‡å®š
- ä¾¿äºåŒç±»é—®é¢˜çš„ç»éªŒå¤ç”¨

### ğŸ” æ™ºèƒ½æœç´¢
- åŸºäºå…³é”®è¯çš„SOPè®°å¿†æœç´¢
- æ”¯æŒé—®é¢˜ç±»å‹å’Œè®°å¿†å†…å®¹çš„è”åˆæœç´¢
- è¿”å›åŒ¹é…åº¦æœ€é«˜çš„ç›¸å…³ç»éªŒ

### ğŸ‘¥ ç”¨æˆ·éš”ç¦»
- æ”¯æŒå¤šç”¨æˆ·ç¯å¢ƒä¸‹çš„è®°å¿†éš”ç¦»
- ç”¨æˆ·ä¸“å±SOPè®°å¿†ä¸å…¨å±€è®°å¿†å¹¶å­˜
- ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·ä¸“å±è®°å¿†

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ä½¿ç”¨

```python
from sop_memory_manager import SopMemoryManager

# åˆ›å»ºç®¡ç†å™¨å®ä¾‹
sop_manager = SopMemoryManager()

# å¤„ç†é—®é¢˜è§£å†³è¿‡ç¨‹å¹¶æå–SOPç»éªŒ
sop_experience = await sop_manager.process_sop_memory(
    user_query="è¯·å¸®æˆ‘åˆ†æé”€å”®æ•°æ®",
    tool_chain=[
        {"tool_name": "read_csv_file", "action_input": {"file_path": "sales.csv"}},
        {"tool_name": "data_analyzer", "action_input": {"data": "é”€å”®æ•°æ®"}}
    ],
    final_result="åˆ†æå®Œæˆï¼šç”µå­äº§å“é”€å”®é¢æœ€é«˜",
    problem_type="æ•°æ®åˆ†æç±»é—®é¢˜",  # å¯é€‰ï¼Œå¯è‡ªåŠ¨è¯†åˆ«
    is_success=True,
    model_name="gpt-4"
)
```

### æ£€ç´¢SOPè®°å¿†

```python
# åŠ è½½ç‰¹å®šé—®é¢˜ç±»å‹çš„SOPè®°å¿†
memory = await sop_manager.load_sop_memory("æ•°æ®åˆ†æç±»é—®é¢˜")

# æœç´¢ç›¸å…³SOPè®°å¿†
results = await sop_manager.search_sop_memories("æ•°æ®åˆ†æ")

# è·å–æ‰€æœ‰SOPè®°å¿†
all_memories = await sop_manager.get_all_sop_memories()
```

### ç”¨æˆ·éš”ç¦»ä½¿ç”¨

```python
# ä¸ºç”¨æˆ·ä¸“å±è®°å¿†
await sop_manager.process_sop_memory(
    user_query="ç”¨æˆ·ä¸“å±æ•°æ®åˆ†æéœ€æ±‚",
    tool_chain=[...],
    final_result="...",
    username="user123"  # æŒ‡å®šç”¨æˆ·å
)

# åŠ è½½ç”¨æˆ·ä¸“å±è®°å¿†
user_memory = await sop_manager.load_sop_memory("æ•°æ®åˆ†æç±»é—®é¢˜", username="user123")
```

## é—®é¢˜ç±»å‹åˆ†ç±»

SopMemoryManager å†…ç½®äº†ä»¥ä¸‹å¸¸è§é—®é¢˜ç±»å‹ï¼š

- **ä¿¡æ¯æ£€ç´¢ç±»é—®é¢˜**ï¼šæ¶‰åŠæœç´¢ã€æŸ¥è¯¢ã€ä¿¡æ¯è·å–
- **æ–‡ä»¶æ“ä½œç±»é—®é¢˜**ï¼šæ¶‰åŠæ–‡ä»¶è¯»å†™ã€å¤„ç†ã€ç®¡ç†
- **æ•°æ®åˆ†æç±»é—®é¢˜**ï¼šæ¶‰åŠæ•°æ®å¤„ç†ã€åˆ†æã€ç»Ÿè®¡
- **ç½‘ç»œæ“ä½œç±»é—®é¢˜**ï¼šæ¶‰åŠç½‘ç»œè¯·æ±‚ã€APIè°ƒç”¨
- **é€šç”¨é—®é¢˜**ï¼šå…¶ä»–æœªåˆ†ç±»çš„é—®é¢˜ç±»å‹

## ä¸ToolMemoryManagerçš„åŒºåˆ«

| ç‰¹æ€§ | ToolMemoryManager | SopMemoryManager |
|------|------------------|------------------|
| **å…³æ³¨ç‚¹** | å•ä¸ªå·¥å…·çš„ä½¿ç”¨ç»éªŒ | å®Œæ•´é—®é¢˜è§£å†³æµç¨‹ |
| **è®°å¿†ç²’åº¦** | å·¥å…·çº§åˆ« | é—®é¢˜ç±»å‹çº§åˆ« |
| **æå–å†…å®¹** | å·¥å…·ä½¿ç”¨æœ€ä½³å®è·µ | æ ‡å‡†è§£é¢˜æµç¨‹ |
| **åº”ç”¨åœºæ™¯** | ä¼˜åŒ–å·¥å…·è°ƒç”¨ | ä¼˜åŒ–é—®é¢˜è§£å†³ç­–ç•¥ |
| **å­˜å‚¨ç´¢å¼•** | å·¥å…·åç§° | é—®é¢˜ç±»å‹ |

## é›†æˆå»ºè®®

### åœ¨Agentç³»ç»Ÿä¸­é›†æˆ

```python
class EnhancedAgent:
    def __init__(self):
        self.sop_manager = SopMemoryManager()
    
    async def solve_problem(self, user_query):
        # 1. å…ˆå°è¯•åŠ è½½ç›¸å…³SOPè®°å¿†
        problem_type = await self.sop_manager._infer_problem_type(user_query, [])
        sop_memory = await self.sop_manager.load_sop_memory(problem_type)
        
        if sop_memory:
            # 2. åŸºäºSOPè®°å¿†åˆ¶å®šè§£å†³ç­–ç•¥
            strategy = self._formulate_strategy(sop_memory)
        else:
            # 3. æ— SOPè®°å¿†æ—¶ä½¿ç”¨é»˜è®¤ç­–ç•¥
            strategy = self._default_strategy()
        
        # 4. æ‰§è¡Œé—®é¢˜è§£å†³
        result = await self._execute_strategy(strategy)
        
        # 5. å¦‚æœæˆåŠŸï¼Œæå–SOPç»éªŒ
        if result.success:
            await self.sop_manager.process_sop_memory(
                user_query=user_query,
                tool_chain=result.tool_chain,
                final_result=result.final_output,
                problem_type=problem_type,
                is_success=True
            )
        
        return result
```

## é…ç½®é€‰é¡¹

### Redisé…ç½®
- ä½¿ç”¨é¡¹ç›®é»˜è®¤çš„Redisè¿æ¥
- æ”¯æŒè‡ªå®šä¹‰Redisç®¡ç†å™¨
- å­˜å‚¨é”®æ ¼å¼ï¼š`sop_memory:{username}:{problem_type}`

### è¿‡æœŸæ—¶é—´
- é»˜è®¤è¿‡æœŸæ—¶é—´ï¼š48å°æ—¶
- å¯è‡ªå®šä¹‰è¿‡æœŸæ—¶é—´
- æ”¯æŒè®°å¿†çš„è‡ªåŠ¨æ¸…ç†

## ç›‘æ§å’Œæ—¥å¿—

- é›†æˆLangfuseè¿›è¡Œæ‰§è¡Œè¿½è¸ª
- è¯¦ç»†çš„æ—¥å¿—è®°å½•
- é”™è¯¯å¤„ç†å’Œå¼‚å¸¸æ•è·

## æœ€ä½³å®è·µ

1. **åŠæ—¶æå–**ï¼šåœ¨é—®é¢˜æˆåŠŸè§£å†³åç«‹å³æå–SOPç»éªŒ
2. **ç±»å‹å‡†ç¡®**ï¼šå°½é‡æä¾›å‡†ç¡®çš„é—®é¢˜ç±»å‹ï¼Œä¾¿äºåç»­æ£€ç´¢
3. **ç»éªŒå¤ç”¨**ï¼šåœ¨è§£å†³æ–°é—®é¢˜æ—¶ä¼˜å…ˆæ£€ç´¢ç›¸å…³SOPè®°å¿†
4. **å®šæœŸæ¸…ç†**ï¼šå®šæœŸæ¸…ç†è¿‡æ—¶æˆ–æ— æ•ˆçš„SOPè®°å¿†
5. **ç”¨æˆ·éš”ç¦»**ï¼šåœ¨å¤šç”¨æˆ·ç¯å¢ƒä¸­ä½¿ç”¨ç”¨æˆ·éš”ç¦»åŠŸèƒ½

## æ‰©å±•å¼€å‘

### è‡ªå®šä¹‰é—®é¢˜ç±»å‹è¯†åˆ«

```python
class CustomSopMemoryManager(SopMemoryManager):
    async def _infer_problem_type(self, user_query: str, tool_chain: List[Dict[str, Any]]) -> str:
        # å®ç°è‡ªå®šä¹‰çš„é—®é¢˜ç±»å‹è¯†åˆ«é€»è¾‘
        if "è´¢åŠ¡" in user_query or "æŠ¥è¡¨" in user_query:
            return "è´¢åŠ¡åˆ†æç±»é—®é¢˜"
        return await super()._infer_problem_type(user_query, tool_chain)
```

### é›†æˆå…¶ä»–å­˜å‚¨åç«¯

```python
class DatabaseSopMemoryManager(SopMemoryManager):
    def _get_redis_connection(self):
        # æ›¿æ¢ä¸ºæ•°æ®åº“è¿æ¥
        return get_database_connection()
```

## æ€»ç»“

SopMemoryManager æä¾›äº†ä¸€ä¸ªå¼ºå¤§çš„æ¡†æ¶æ¥ç®¡ç†å’Œå¤ç”¨é—®é¢˜è§£å†³ç»éªŒï¼Œèƒ½å¤Ÿæ˜¾è‘—æå‡AIç³»ç»Ÿåœ¨å¤„ç†é‡å¤æ€§é—®é¢˜æ—¶çš„æ•ˆç‡å’Œå‡†ç¡®æ€§ã€‚é€šè¿‡ä¸ToolMemoryManagerçš„é…åˆä½¿ç”¨ï¼Œå¯ä»¥æ„å»ºä¸€ä¸ªå®Œæ•´çš„ç»éªŒå­¦ä¹ å’Œå¤ç”¨ç³»ç»Ÿã€‚